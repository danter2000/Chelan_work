---
title: "Chelan_PUD_Work"
author: "Dante Ramirez"
date: '2023-04-24'
output: html_document
---

```{r setup, warning = F, message = F}

# General Data Tidying
library(tidyverse)
library(janitor)
library(data.table)

# For Animations
library(ggiraph)
library(gganimate)

# For Dashboard
library(shinydashboard)
library(shiny)

chelan_df <- read_csv(file= "PreAssignmentDataSet_StatorTemp.csv") %>%
  clean_names()

```

```{r Q1}

chelan_df_long <- chelan_df %>%
  pivot_longer(cols = -c(1,2), 
               names_to = c("unit_num", ".value"), 
               names_pattern = "c_(\\d+)_(\\w+)_") %>%
               mutate(unit_num = as.factor(as.numeric(unit_num)))
              

chelan_df_long$unit_num <- paste("Unit C", chelan_df_long$unit_num, sep = "")

colSums(is.na(chelan_df_long))
sum(is.na(chelan_df_long))

chelan_df_long[is.na(chelan_df_long)] <- 0

chelan_df_long <- chelan_df_long %>%
  mutate(unit_status = ifelse(total_current > 10, "On", "Off")) %>%
  mutate(timestamp_utc = as.POSIXct(timestamp_utc)) %>%
  mutate(unit_num = as.factor(unit_num))

```

```{r Q2}

chelan_df_long %>% filter(unit_num == "Unit C6",
                          unit_status == "Off") %>%
  nrow()

```

```{r Q3 and Q4}

chelan_df_long %>% filter(unit_num == "Unit C6") %>% 
  group_by(month = lubridate::floor_date(timestamp_utc, 'month')) %>%
  summarise(monthly_offline_hrs = sum(unit_status == "Off"),
            monthly_offline_prop = round(sum(unit_status == "Off") / length(unit_status),
                                         3))

```

```{r Q5}

chelan_df_long %>% group_by(unit_num) %>%
  summarise(online_hrs = sum(unit_status == "On"))

```

```{r Q6}

chelan_df_long %>% filter(unit_status == "Off") %>%
  group_by(hour = hour(timestamp_utc)) %>%
  summarise(offline_hours_totals = length(unit_status)) 

```

```{r Q7}

plot_chelan_raw <- function(data, time_var, y_var) {

min_idx <- which.min(data[[y_var]])
max_idx <- which.max(data[[y_var]])

if (y_var == "avg_winding_temp") {
    y_axis_title <- "Average Stator Winding Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "total_current") {
    y_axis_title <- "Total Current (A)"
    legend_title <- "(A)"
  } else if (y_var == "avg_cooling_water_flow_gal") {
    y_axis_title <- "Average Cooling Water Flow (gal/min)"
    legend_title <- "(gal/min)"
  } else if (y_var == "avg_cooling_water_temp") {
    y_axis_title <- "Average Cooling Water Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "avg_cooling_air_out_temp") {
    y_axis_title <- "Average Cooling Air Out Temperature (°C)"
    legend_title <- "(°C)"
  }

ggplot(data, aes_string(x = time_var, y = y_var, color = y_var)) +
  geom_point(aes(col = ..y..)) +
  geom_smooth(color = "grey", size = 1.5) +
  scale_color_gradient2(low = "blue", high = "red", mid = "yellow",
                        midpoint = median(data[[y_var]]),
                        name = legend_title) +
  theme_classic() +
  geom_vline(xintercept = c(as.POSIXct("2018-03-20"),
                            as.POSIXct("2018-06-21"),
                            as.POSIXct("2018-09-22"),
                            as.POSIXct("2018-12-21")),
             colour = "grey",
             alpha = 0.5) +
  annotate("text", x = c(as.POSIXct("2018-02-05"),
                         as.POSIXct("2018-05-05"),
                         as.POSIXct("2018-08-05"),
                         as.POSIXct("2018-11-05")),
           y = max(data[[y_var]]) * 1.05,
           label = c("Winter", "Spring", "Summer", "Autumn"),
           colour = "grey",
           size = 4) +
           theme(axis.title.x = element_blank()) +
           labs(y = y_axis_title) +
           scale_x_datetime(date_labels = "%b",
                            breaks = scales::date_breaks("1 month"),
                            labels = format(as.POSIXct(data[[time_var]]), "%b"))
  
}

plot_chelan_raw(chelan_df_long, "timestamp_utc", "avg_cooling_water_temp")

plot_chelan_loess <- function(data, time_var, y_var) {

min_idx <- which.min(data[[y_var]])
max_idx <- which.max(data[[y_var]])

if (y_var == "avg_winding_temp") {
    y_axis_title <- "Average Stator Winding Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "total_current") {
    y_axis_title <- "Total Current (A)"
    legend_title <- "(A)"
  } else if (y_var == "avg_cooling_water_flow_gal") {
    y_axis_title <- "Average Cooling Water Flow (gal/min)"
    legend_title <- "(gal/min)"
  } else if (y_var == "avg_cooling_water_temp") {
    y_axis_title <- "Average Cooling Water Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "avg_cooling_air_out_temp") {
    y_axis_title <- "Average Cooling Air Out Temperature (°C)"
    legend_title <- "(°C)"
  }

ggplot(data, aes_string(x = time_var, y = y_var, color = y_var)) +
  geom_smooth(aes(col = ..y..)) +
  scale_color_gradient2(low = "blue", high = "red", mid = "yellow",
                        midpoint = median(data[[y_var]]),
                        name = legend_title) +
  theme_classic() +
  geom_vline(xintercept = c(as.POSIXct("2018-03-20"),
                            as.POSIXct("2018-06-21"),
                            as.POSIXct("2018-09-22"),
                            as.POSIXct("2018-12-21")),
             colour = "grey",
             alpha = 0.5) +
  annotate("text", x = c(as.POSIXct("2018-02-05"),
                         as.POSIXct("2018-05-05"),
                         as.POSIXct("2018-08-05"),
                         as.POSIXct("2018-11-05")),
           y = max(data[[y_var]]) * 1.05,
           label = c("Winter", "Spring", "Summer", "Autumn"),
           colour = "grey",
           size = 4) +
           theme(axis.title.x = element_blank()) +
           labs(y = y_axis_title) +
           scale_x_datetime(date_labels = "%b",
                            breaks = scales::date_breaks("1 month"),
                            labels = format(as.POSIXct(data[[time_var]]), "%b"))
  
}

plot_chelan_loess(chelan_df_long, "timestamp_utc", "total_current")

```

```{r Q8}

plot_chelan_loess_group <- function(data, time_var, y_var) {

min_idx <- which.min(data[[y_var]])
max_idx <- which.max(data[[y_var]])

if (y_var == "avg_winding_temp") {
    y_axis_title <- "Average Stator Winding Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "total_current") {
    y_axis_title <- "Total Current (A)"
    legend_title <- "(A)"
  } else if (y_var == "avg_cooling_water_flow_gal") {
    y_axis_title <- "Average Cooling Water Flow (gal/min)"
    legend_title <- "(gal/min)"
  } else if (y_var == "avg_cooling_water_temp") {
    y_axis_title <- "Average Cooling Water Temperature (°C)"
    legend_title <- "(°C)"
  } else if (y_var == "avg_cooling_air_out_temp") {
    y_axis_title <- "Average Cooling Air Out Temperature (°C)"
    legend_title <- "(°C)"
  }

ggiraph(code = print(ggplot(data, aes_string(x = time_var, y = y_var,
                        color = data$unit_num, group = data$unit_num)) +
  geom_smooth_interactive(aes(col = ..y..,
                              tooltip = paste0("", data$unit_num)),
                          size = 1.5) +
  scale_color_gradient2(low = "blue", high = "red", mid = "yellow",
                        midpoint = median(data[[y_var]]),
                        name = legend_title) +
  theme_classic() +
  geom_vline(xintercept = c(as.POSIXct("2018-03-20"),
                            as.POSIXct("2018-06-21"),
                            as.POSIXct("2018-09-22"),
                            as.POSIXct("2018-12-21")),
             colour = "grey",
             alpha = 0.5) +
  annotate("text", x = c(as.POSIXct("2018-02-05"),
                         as.POSIXct("2018-05-05"),
                         as.POSIXct("2018-08-05"),
                         as.POSIXct("2018-11-05")),
           y = max(data[[y_var]]) * 1.05,
           label = c("Winter", "Spring", "Summer", "Autumn"),
           colour = "grey",
           size = 4) +
           theme(axis.title.x = element_blank()) +
           labs(y = y_axis_title) +
           scale_x_datetime(date_labels = "%b",
                            breaks = scales::date_breaks("1 month"),
                            labels = format(as.POSIXct(data[[time_var]]), "%b"))))
  
}

plot_chelan_loess_group(chelan_df_long, "timestamp_utc", "total_current")

```

```{r Q9}


ui <- dashboardPage(
  dashboardHeader(title = "Unit Diagnostics"),
  dashboardSidebar(
    sliderInput("slider", "Slider input:", 1, 100, 50)
  ),
  dashboardBody(
    # Boxes need to be put in a row (or column)
    fluidRow(
      box(plotOutput("plot1", height = 250)
      ),
      box(tableOutput("table1")
      )
    )
  )
)

server <- function(input, output) {
  set.seed(122)
  histdata <- rnorm(500)

  output$plot1 <- renderPlot({
    data <- histdata[seq_len(input$slider)]
    hist(data)
  })
  
  output$table1 <- renderTable({
    data <- histdata[seq_len(input$slider)]
    tibble(data)
  })
}

shinyApp(ui, server)

```